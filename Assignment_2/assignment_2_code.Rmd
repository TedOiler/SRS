---
title: "Assignment 2"
author: "Ted Ladas - s2124289"
output: html_document
---

```{r setup, include=FALSE}
require(kdensity)
knitr::opts_chunk$set(echo = FALSE)
```


```{r KDE vs Histogram}
# Requirements and hyperparameters:
set.seed(1903)
n_small = 200
n_large = 1e6
U_small = runif(n_small)
U_large = runif(n_large)

hyp_bins_small  = 20
hyp_bins_large  = 30
hyp_norm_mean   = 0
hyp_norm_sd     = 1
hyp_gamma_shape = 5
hyp_gamma_rate  = 1
hyp_mixing      = 0.5
hyp_ban         = 'nrd0'

set_kde = function(data,data_den,length,x_start,x_end,bins,
                    hyp_mean=hyp_norm_mean,
                    hyp_sd=hyp_norm_sd,
                    hyp_shape=hyp_gamma_shape,
                    hyp_rate=hyp_gamma_rate,
                    mixing = hyp_mixing){
  ## This function optimizes the kernel bandwidth for the KDE by a minimizing 
  ## the euclidean distance on a grid of given values. In can be further 
  ## enchanted easily, but this is a basic first prototype.
  h_seq = seq(1e-5, 10, by=0.1)
  dist_matrix = as.vector(matrix(1,nrow=length(h_seq)))
  x_in = seq(x_start, x_end, length.out=length)
  
  if(data_den=='norm')      {y_out = dnorm(x_in, mean=hyp_mean, sd=hyp_sd)}
  else if(data_den=='gamma'){y_out = dgamma(x_in, shape=hyp_shape, rate=hyp_rate)}
  else                      {y_out = mixing*dnorm (x_in, mean=hyp_mean, sd=hyp_sd) + 
                                      (1-mixing)*dgamma(x_in, shape=hyp_shape, rate=hyp_rate)}
  
  for(i in 1:length(h_seq)){
    kde_den=density(data,bw=h_seq[i],kernel='gaussian',n=bins)
    #dist_matrix[i]=sqrt(sum((kde_den$y-y_out)^2))
    dist_matrix[i]=sqrt(mean(outer(kde_den$y,y_out,"-")^2))
  }
  hyp_ban_opt = h_seq[which.min(dist_matrix)]
  kde_den=density(data,bw=hyp_ban_opt,kernel='gaussian',n=bins)
  
  # check whether the default bandwidth is better
  
  kde_den_default=density(data,bw='nrd0',kernel='gaussian',n=bins)
  gs_error = sqrt(mean(outer(kde_den$y,y_out,"-")^2)) # grid search min error
  df_error = sqrt(mean(outer(kde_den_default$y,y_out,"-")^2)) #default terror
  
  if(TRUE){ # the algorithm doesn't work yet 100% so this is why this locking mechanism exists for now
    cat('Switching to default parameters for KDE')
    kde_den = density(data,bw='nrd0',kernel='gaussian',n=bins)
  }
  return(kde_den)
}


# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Generate the unimodal data
y_small_uni_normal  = rnorm (n_small,
                            mean=hyp_norm_mean,
                            sd=hyp_norm_sd)
y_small_uni_gamma   = rgamma(n_small,
                            shape=hyp_gamma_shape,
                            rate=hyp_gamma_rate)
y_large_uni_normal  = rnorm (n_large,
                            mean=hyp_norm_mean,
                            sd=hyp_norm_sd)
y_large_uni_gamma   = rgamma(n_large,
                            shape=hyp_gamma_shape,
                            rate=hyp_gamma_rate)

# Generate the multimodal data
y_small_multi_norm_gamma = rep(NA, n_small)
y_large_multi_norm_gamma = rep(NA, n_large)

for(i in 1:n_small){
  if(U_small[i]<hyp_mixing){y_small_multi_norm_gamma[i] = rnorm (1,mean=hyp_norm_mean,sd=hyp_norm_sd)}
  else                     {y_small_multi_norm_gamma[i] = rgamma(1,shape=hyp_gamma_shape,rate=hyp_gamma_rate)}
}

for(i in 1:n_large){
  if(U_large[i]<hyp_mixing){y_large_multi_norm_gamma[i] = rnorm (1,mean=hyp_norm_mean,sd=hyp_norm_sd)}
  else                     {y_large_multi_norm_gamma[i] = rgamma(1,shape=hyp_gamma_shape,rate=hyp_gamma_rate)}
}


# Histograms and KDE
# KDEs
kde_small_uni_normal        = set_kde(data=y_small_uni_normal,data_den='norm',bins=hyp_bins_small,
                                      length=n_small,
                                      x_start=-5,
                                      x_end=5)

kde_small_uni_gamma         = set_kde(data=y_small_uni_gamma,data_den='gamma',bins=hyp_bins_small,
                                      length=n_small,
                                      x_start=-2,
                                      x_end=15)

kde_small_multi_norm_gamma  = set_kde(data=y_small_multi_norm_gamma,data_den='normgamma',bins=hyp_bins_small,
                                      length=n_small,
                                      x_start=-5,
                                      x_end=15)


kde_large_uni_normal        = set_kde(data=y_large_uni_normal,data_den='norm',bins=hyp_bins_large,
                                      length=n_large,
                                      x_start=-5,
                                      x_end=5)

kde_large_uni_gamma         = set_kde(data=y_large_uni_gamma,data_den='gamma',bins=hyp_bins_large,
                                      length=n_large,
                                      x_start=-2,
                                      x_end=15)

kde_large_multi_norm_gamma  = set_kde(data=y_large_multi_norm_gamma,data_den='normgamma',bins=hyp_bins_large,
                                      length=n_large,
                                      x_start=-4,
                                      x_end=15)

scaler=0.6
jpeg("./images/hist_vs_GKDE.jpg", width=4096*scaler, height=2160*scaler)
par(mfrow=c(2,3))
font = 2.2
x = seq(-5, 5, length.out=n_small)
y = dnorm(x, mean=hyp_norm_mean, sd=hyp_norm_sd)
hist(y_small_uni_normal,
     col='skyblue3',
     breaks=hyp_bins_small,
     freq= FALSE,
     main = 'Small Normal',
     xlab='Index',
     xlim=c(-5,5),
     ylim=c(0,0.5),
     cex.lab=font,
     cex.axis=font,
     cex.main=font,
     cex.sub=font)
lines(kde_small_uni_normal,
      lwd=2,
      col='chocolate1')
lines(x,y,
      lwd=2)
rug(y_small_uni_normal)

x = seq(-2, 15, length.out=n_small)
y = dgamma(x, shape=hyp_gamma_shape, rate=hyp_gamma_rate)
hist(y_small_uni_gamma,
     col='skyblue3',
     breaks=hyp_bins_small,
     freq= FALSE,
     main = 'Small Gamma',
     xlab='Index',
     xlim=c(-2,15),
     ylim=c(0,0.3),
     cex.lab=font,
     cex.axis=font,
     cex.main=font,
     cex.sub=font)
lines(kde_small_uni_gamma,
      lwd=2,
      col='chocolate1')
lines(x,y,
      lwd=2)
rug(y_small_uni_gamma)

x = seq(-5, 15, length.out=n_small)
y =  hyp_mixing      *dnorm (x, mean=hyp_norm_mean   , sd=hyp_norm_sd     ) +
      (1- hyp_mixing )*dgamma(x, shape=hyp_gamma_shape, rate=hyp_gamma_rate)
hist(y_small_multi_norm_gamma,
     col='skyblue3',
     breaks=hyp_bins_small,
     freq= FALSE,
     main = 'Small Normal-Gamma',
     xlab='Index',
     xlim=c(-5,15),
     ylim=c(0,0.2),
     cex.lab=font,
     cex.axis=font,
     cex.main=font,
     cex.sub=font)
lines(kde_small_multi_norm_gamma,
      lwd=2,
      col='chocolate1')
lines(x,y,
     lwd=2)
legend("topright",
       c("Gaussian Kernel", "Histogram", "True Distribution"),
       col=c("chocolate1", "skyblue3","black"),
       lwd=10,
       cex=font)
rug(y_small_multi_norm_gamma)

#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

x = seq(-5, 5, length.out=n_large)
y = dnorm(x, mean=hyp_norm_mean, sd=hyp_norm_sd)
hist(y_large_uni_normal,
     col='darkolivegreen',
     breaks=hyp_bins_large,
     freq= FALSE,
     main = 'Large Normal',
     xlab='Index',
     xlim=c(-5,5),
     ylim=c(0,0.5),
     cex.lab=font,
     cex.axis=font,
     cex.main=font,
     cex.sub=font)
lines(kde_large_uni_normal,
      lwd=2,
      col='deeppink')
lines(x,y,
      lwd=2)

x = seq(-2, 15, length.out=n_large)
y = dgamma(x, shape=hyp_gamma_shape, rate=hyp_gamma_rate)
hist(y_large_uni_gamma,
     col='darkolivegreen',
     breaks=hyp_bins_large,
     freq= FALSE,
     main = 'Large Gamma',
     xlab='Index',
     xlim=c(-2,15),
     ylim=c(0,0.3),
     cex.lab=font,
     cex.axis=font,
     cex.main=font,
     cex.sub=font)
lines(kde_large_uni_gamma,
      lwd=2,
      col='deeppink')
lines(x,y,
      lwd=2)

x = seq(-4, 15, length.out=n_large)
y =  hyp_mixing      *dnorm (x, mean=hyp_norm_mean   , sd=hyp_norm_sd     ) +
      (1- hyp_mixing )*dgamma(x, shape=hyp_gamma_shape, rate=hyp_gamma_rate)
hist(y_large_multi_norm_gamma,
     col='darkolivegreen',
     breaks=hyp_bins_large,
     freq= FALSE,
     main = 'Large Normal-Gamma',
     xlab='Index',
     xlim=c(-4,15),
     ylim=c(0,0.3),
     cex.lab=font,
     cex.axis=font,
     cex.main=font,
     cex.sub=font)
lines(kde_large_multi_norm_gamma,
      lwd=2,
      col='deeppink')
lines(x,y,
      lwd=2)
legend("topright",
       c("Gaussian Kernel", "Histogram", "True Distribution"),
       col=c("deeppink", "darkolivegreen","black"),
       lwd=10,
       cex=font)


dev.off()
par(mfrow=c(1,1))

cat("\n###Script executed successfully!###")
```

```{r MCMC}

set.seed(1903)
n_1             = 15
R               = 1000
hyp_mixing      = 0.5
hyp_norm_mean   = 0
hyp_norm_sd     = 1
hyp_gamma_shape = 5
hyp_gamma_rate  = 1

y_uni_normal = matrix(NA, R, n) 
mu_norm = numeric(R) 
med = numeric(R)
U = runif(n_1)

# MCMC
for(r in 1:R){
  y_uni_normal[r, ] = rnorm (n_1,mean=hyp_norm_mean,sd=hyp_norm_sd)
  #y_uni_gamma[r, ]  = rgamma(n_1,shape=hyp_gamma_shape,rate=hyp_gamma_rate)
  #y_multi_norm_gamma[r, ] = rep(NA, n_1)
  #for(i in 1:n_1){
  #  if(U[i]<hyp_mixing){y_multi_norm_gamma[i]=rnorm (1,mean=hyp_norm_mean,sd=hyp_norm_sd)}
  #  else               {y_multi_norm_gamma[i]=rgamma(1,shape=hyp_gamma_shape,rate=hyp_gamma_rate)}
  #}
  
  mu_norm[r] = mean(y_uni_normal[r, ])
  #mu_gamma[r] = mean(y_uni_gamma[r, ])
  #mu_mix[r] = mean(y_multi_norm_gamma[r, ])
}

MCMC_mu_norm  = mean(mu_norm)
#MCMC_mu_gamma = mean(mu_gamma)
#MCMC_mu_mix   = mean(mu_mix)
MCMC_mu_norm
#MCMC_mu_gamma
#MCMC_mu_mix
```